<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/tmcpmain.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/cytobrowsertheme.css">
    <link rel="stylesheet" href="css/tm-icon-style.css">
    <title>TissUUmaps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/d3.v4.min.js"></script>
    <script src="js/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="js/jquery-3.4.1.slim.min.js"></script>
</head>

<style>
    head, body { height: 100%; }
</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
        <a class="navbar-brand" href="https://tissuumaps.research.it.uu.se/">
            <img style="height:50px; margin:-5px; overflow: visible" src="misc/uulogowhitetuum.png">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_items">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar_items">
            <ul class="nav navbar-nav">
                <li>
                    <a id="project_title" class="nav-link" href "#"> Slide A</a>
                </li>
            </ul>
            <ul class="nav navbar-nav">
                <li class="nav-item"><a class="nav-link">Image: <span id="img_name"> -</span></a></li>
                <li class="nav-item"><a class="nav-link"> Z-level: <span id="img_zlevel"> -</span></a></li>
                <li class="nav-item"><a class="nav-link"> Zoom: <span id="img_zoom"> -</span></a></li>
			</ul>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div id="ISS_viewer" class="ISS_viewer"></div>
                <div id="alert_wrapper" style="height: 100%; width: 100%; display: flex; justify-content: center; align-items: center; position: absolute; top: 0; pointer-events: none"></div>
            </div>

            <div class="col-auto d-flex flex-column">
                <div class="row">
                    <div class="card m-2 w-100">
                        <!-- Image browser access -->
                        <div class="card-body">
                            <button type="button" class="btn btn-block btn-primary" data-toggle="modal" data-target="#image_browser">
                                Open image browser
                            </button>
                            <button type="button" class="btn btn-block btn-secondary" data-toggle="modal" data-target="#instructions">
                                Usage instructions
                            </button>
                        </div>
                        <hr />

                        <!-- Functionality buttons -->
                        <div class="card-body">
                            <h4 class="card-title">Options</h4>
                            <div class="card-block">
                                <div class="row">
                                    <div class="col-auto">
                                        <h6 class="card-subtitle mb-2 text-muted">Marker class</h6>
                                        <div id="class_buttons" class="btn-group btn-group-toggle d-flex" data-toggle="buttons" role="group">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="card-subtitle mb-2 text-muted">Change focus</h6>
                                        <div class="btn-group d-flex" role="group">
                                            <button id="focus_next" type="button" class="btn btn-primary">Up</button>
                                            <button id="focus_prev" type="button" class="btn btn-primary">Down</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row flex-grow-1">
                    <div class="card flex-grow-1 m-2 w-100">
                        <!-- List of markers -->
                        <div class="card-body">
                            <h4 class="card-title">Markers</h4>
                            <div class="row pb-3">
                                <div class="col-3">
                                    <button id="pointstojson" class="btn btn-primary btn-block" type="button"> Download</button>
                                </div>
                                <div class="col-3">
                                    <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
                                    <button id="jsontodata" class="btn btn-primary btn-block" type="button"> Import </button>
                                </div>
                                <div class="col-6">
                                    <input class="form-control form-control-file" type="file" id="data_files_import" name="files[]">
                                </div>
                            </div>
                        </div>
                        <div style="height: 40vh; overflow-y: auto;"> <!-- TODO: Table should ideally fill remaining height of menu, not a specific fraction of viewport -->
                            <table id="tmcptable" class="table table-striped table-hover">
                                <col width="10%"><col width="70%"> <col width="30%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th id="thimg1">Annotation</th>
                                        <th>&nbsp;</th>
                                    </tr>
                                </thead>
                                <tbody id="tmcptablebody" class="h-20">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of container -->

    <!-- Image browser TODO -->
    <div class="modal fade" id="image_browser" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select an image</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div id="available_images" class="modal-body">

          </div>
        </div>
      </div>
    </div> <!-- End of image browser -->

    <!-- Instructions -->
    <div class="modal fade" id="instructions" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">How to use</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <h5>Loading images</h5>
              <p>
                  Click the button labeled <strong>Image browser</strong>
                  to see a list of available images on the server. Click
                  one of the images to view it.
              </p>
              <h5>Navigating images</h5>
              <p>
                  The image viewer can be navigated with the mouse. The
                  mouse wheel is used to zoom in and out of the picture.
                  Holding down the left mouse button and dragging it inside
                  the image viewer pans the image. The focus can be changed
                  either by pressing the <strong>Up</strong> and <strong>Down</strong>
                  buttons on the right side of the page, pressing the
                  <kbd>z</kbd> and <kbd>x</kbd> buttons on the keyboard,
                  or holding down the <kbd>ctrl</kbd> key while scrolling
                  the mouse wheel.
              </p>
              <h5>Markers</h5>
              <p>
                  Click the image viewer to add a marker with the currently
                  selected class. The selected class can be set by either
                  clicking the class buttons on the right side of the page
                  or by pressing the number keys on the keyboard.
                  Markers can be moved by holding down the mouse button
                  on them and dragging them. To delete a marker, click
                  it while holding down the <kbd>ctrl</kbd> key. To quickly
                  move the image viewer to a specific marker, press the
                  corresponding button in the marker table.
              </p>
              <h5>Saving markers</h5>
              <p>
                  Markers can be saved to a file on the local machine by
                  pressing the <strong>Download</strong> button. Markers
                  that have been saved can be loaded into the image by
                  first selecting the file in the image browser and then
                  pressing the <strong>Import</strong> button.
          </div>
        </div>
      </div>
    </div> <!-- End of instructions -->
</body>

<script src="js/bootstrap.4.0.0.bundle.min.js" ></script>
<script src="js/openseadragon.2.4.0.min.js"></script>
<script src="js/openseadragon-filtering.js"></script>
<script src="js/openseadragon-svg-overlay.js"></script>
<!-- <script src="js/tm_utils/interfaceUtils.js"></script> -->
<!-- <script src="js/tm_utils/dataUtils.js"></script> -->
<!-- <script src="js/tm_utils/CPDataUtils.js"></script> -->
<!-- <script src="js/tm_utils/markerUtils.js"></script> -->
<script src="js/tm_utils/OSDViewerUtils.js"></script>
<!-- <script src="js/tm_utils/HTMLElementUtils.js"></script> -->
<!-- <script src="js/tm_utils/regionUtils.js"></script> -->
<!-- <script src="js/tm_utils/overlayUtils.js"></script> -->
<!-- <script src="js/tm_utils/geometryUtils.js"></script> -->
<script src="js/utils/bethesdaClassUtils.js"></script>
<script src="js/utils/JSONUtils.js"></script>
<script src="js/utils/overlayUtils.js"></script>
<script src="js/utils/markerUtils.js"></script>
<script src="js/collabClient.js"></script>
<script src="js/markerPoints.js"></script>
<script src="js/tmapp.js"></script>
<script>
    markerUtils._TMCPStyle={ strokeWidth: 4, radius: 80, drawText:false, textSize:1 };

    document.getElementById("project_title").innerText = "Cyto Browser";

    // Populate the class buttons programatically
    bethesdaClassUtils.forEachClass(function(item, index){
        let label = $("<label></label>");
        label.addClass("btn btn-dark");
        if (index == 0) { label.addClass("active"); }
        label.attr("id", "class_" + item.name);
        label.attr("title", item.description);
        let input = $("<input>" + item.name + "</input>");
        input.attr("type", "radio");
        input.attr("name", "class_options");
        input.attr("autocomplete", "off");
        label.append(input);
        $("#class_buttons").append(label);
    });

    // Start our tmapp
    $(document).ready(function () {
        var url = new URL(window.location.href);
        tmapp.fixed_file = url.searchParams.get("image"); //TODO: Give sensible error message if "image" key is missing
//        tmapp.registerActions();

        // Get the viewport params from the URL
        const initial_params = {
            zoom: url.searchParams.get("zoom"),
            x: url.searchParams.get("x"),
            y: url.searchParams.get("y"),
            z: url.searchParams.get("z")
        };
        // Check if all params are present
        const values = Object.values(initial_params);
        const params_defined = values.every(value => value != null);

        // Set the initial params if all are defined
        if (params_defined) {
            // Convert to numbers first
    	    for (const [key, value] of Object.entries(initial_params)) {
                    initial_params[key] = Number(value);
    	    }
            tmapp.initial_params = initial_params;
        }
        tmapp.init();
    });

    // Add images to the browser
    function addImage(image) {
        // Messy function, might want to do it some better way
        let deck = $("#available_images .row").last();
        if (deck.length === 0 || deck.children().length === 3) {
            deck = $("<div></div>");
            deck.addClass("row mb-4");
            $("#available_images").append(deck);
        }
        const col = $("<div></div>");
        col.addClass("col-4 d-flex");
        const card = $("<div></div>");
        card.addClass("card w-100");
        const overview = $("<img>", {src: image.thumbnails.overview});
        overview.addClass("card-img-top position-absolute");
        const detail = $("<img>", {src: image.thumbnails.detail});
        detail.addClass("card-img-top hide fade");
        detail.css({zIndex: 9000, pointerEvents: "none"});
        const body = $("<div></div>");
        body.addClass("card-body");
        const title = $("<h5></h5>");
        title.text(image.name);
        title.addClass("card-title");
        const footer = $("<div></div>");
        footer.addClass("card-footer");
        const a = $("<a></a>");
        a.addClass("card-link stretched-link");
        a.attr("href", `/?image=${image.name}`);
        a.text("Open image");
        a.hover((e) =>
            detail.addClass("show").removeClass("hide"),
            (e) =>
            detail.addClass("hide").removeClass("show")
        );
        footer.append(a);
        body.append(title);
        card.append(overview);
        card.append(detail);
        card.append(body);
        card.append(footer);
        col.append(card);
        deck.append(col);
    }

    // UI setters
    function setImageName(txt) {
        document.getElementById("img_name").innerText=txt;
    }
    function setImageZLevel(txt) {
        document.getElementById("img_zlevel").innerText=txt;
    }
    function setImageZoom(txt) {
        document.getElementById("img_zoom").innerText=txt;
    }
    function setURL(txt) {
        window.history.pushState(null, "", txt);
    }

    let errorDisplayTimeout = null;
    function displayImageError(error, duration) {
        const errors = {
            noimage: {
                message: "No image has been specified. Select one from the menu on the right.",
                type: "alert-info"
            },
            badimage: {
                message: "The specified image was not found. Select a new one from the menu on the right.",
                type: "alert-warning"
            },
            servererror: {
                message: "Something went wrong on the server. Try again or contact an administrator.",
                type: "alert-warning"
            },
            unexpected: {
                message: "An unexpected error was encountered when retrieving the image list.",
                type: "alert-warning"
            },
            tilefail: {
                message: "Failed to load image tile from server.",
                type: "alert-danger"
            }
        };

        // Add alert to the UI
        const alert = $("<div></div>");
        alert.addClass(`alert ${errors[error].type}`);
        alert.text(errors[error].message);
        window.clearTimeout(errorDisplayTimeout);
        $("#alert_wrapper").removeClass("fade out");
        $("#alert_wrapper").html(alert);

        // Fade out the alert after the duration has passed
        if (duration) {
            errorDisplayTimeout = window.setTimeout(function() {
                $("#alert_wrapper").addClass("fade out");
            }, duration);
        }
    }

    $(document).mousedown(function(event){
        if (!(document.hasFocus())) {
            console.log("Lost focus, ignoreing click and setting focus")
            tmcpoints.fixed_viewer.canvas.focus();
        }
    });

    //1,2,... for class selection
    //z,x for focus up down
    $(document).keypress(function(){
        console.log(event.which);
        switch(event.which) {
            case "z".charCodeAt(): document.getElementById("focus_prev").click(); break;
            case "x".charCodeAt(): document.getElementById("focus_next").click(); break;
            default:
                // Handle digit keys being pressed for classes
                const digits = Array.from({length: 10}, (v,k) => String((k+1) % 10));
                const chars = digits.map((digit) => digit.charCodeAt());
                chars.slice(0, bethesdaClassUtils.amountClasses).forEach((char, index) => {
                    if (event.which == char) {
                        $("#class_" + bethesdaClassUtils.getClassFromID(index).name).click();
                    }
                });
        }
    });
</script>
</html>
