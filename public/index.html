<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/tmcpmain.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/cytobrowsertheme.css">
    <link rel="stylesheet" href="css/tm-icon-style.css">
    <title>TissUUmaps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/d3.min.js"></script>
    <script src="js/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="js/jquery-3.4.1.slim.min.js"></script>
</head>

<!-- Styling required to cover full page -->
<style>
    html, body {
        height: 100%;
    }
    body {
        display: flex;
        flex-direction: column;
    }
</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
        <a class="navbar-brand" href="https://tissuumaps.research.it.uu.se/">
            <img style="height:50px; margin:-5px; overflow: visible" src="misc/uulogowhitetuum.png">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_items">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbar_items">
            <ul class="nav navbar-nav">
                <li>
                    <a id="project_title" class="nav-link" href "#"> Slide A</a>
                </li>
            </ul>
            <ul class="nav navbar-nav">
                <li class="nav-item"><a class="nav-link">Image: <span id="img_name"> -</span></a></li>
                <li class="nav-item"><a class="nav-link"> Z-level: <span id="img_zlevel"> -</span></a></li>
                <li class="nav-item"><a class="nav-link"> Zoom: <span id="img_zoom"> -</span></a></li>
			</ul>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container-fluid d-flex flex-column flex-fill">
        <div class="row flex-fill">
            <div class="col mb-3">
                <div id="ISS_viewer" class="ISS_viewer blurrable"></div>
                <div id="alert_wrapper" style="height: 100%; width: 100%; display: flex; justify-content: center; align-items: center; position: absolute; top: 0; pointer-events: none"></div>
            </div>

            <div class="col-auto d-flex flex-column mb-2">
                <div class="row flex-fill">
                    <div class="card m-2 w-100">
                        <!-- Modal access -->
                        <div class="card-body">
                            <button type="button" class="btn btn-block btn-primary" data-toggle="modal" data-target="#image_browser">
                                Open image browser
                            </button>
                            <button type="button" class="btn btn-block btn-primary" data-toggle="modal" data-target="#collaboration_menu">
                                Open collaboration menu
                            </button>
                            <button type="button" class="btn btn-block btn-secondary" data-toggle="modal" data-target="#instructions">
                                Usage instructions
                            </button>
                        </div>
                        <hr />

                        <!-- Functionality buttons -->
                        <div class="card-body">
                            <!--<h4 class="card-title">Options</h4>-->
                            <div class="card-block">
                                <div class="row">
                                    <div class="col-auto">
                                        <h6 class="card-subtitle mb-2 text-muted">Marker class</h6>
                                        <div id="class_buttons" class="btn-group btn-group-toggle d-flex" data-toggle="buttons" role="group">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="card-subtitle mb-2 text-muted">Change focus</h6>
                                        <div class="btn-group d-flex" role="group">
                                            <button id="focus_next" type="button" class="btn btn-primary">Up</button>
                                            <button id="focus_prev" type="button" class="btn btn-primary">Down</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- List of markers -->
                        <div class="card-body">
                            <!--<h4 class="card-title">Markers</h4>-->
                            <div class="row pb-3">
                                <div class="col-3">
                                    <button id="pointstojson" class="btn btn-primary btn-block" type="button"> Download</button>
                                </div>
                                <div class="col-3">
                                    <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
                                    <button id="jsontodata" class="btn btn-primary btn-block" type="button"> Import </button>
                                </div>
                                <div class="col-6">
                                    <input class="form-control form-control-file" type="file" id="data_files_import" name="files[]">
                                </div>
                            </div>
                        </div>
                        <div class="h-100 overflow-auto position-relative">
                            <table id="tmcptable" class="table table-striped table-hover position-absolute">
                                <col width="10%"><col width="70%"> <col width="30%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th id="thimg1">Annotation</th>
                                        <th>&nbsp;</th>
                                    </tr>
                                </thead>
                                <tbody id="tmcptablebody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of container -->

    <!-- Image browser -->
    <div class="modal fade" id="image_browser" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select an image</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div id="available_images" class="modal-body">

          </div>
        </div>
      </div>
    </div> <!-- End of image browser -->

    <!-- Instructions -->
    <div class="modal fade" id="instructions" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">How to use</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <h5>Collaboration</h5>
              <p>
                  A collaboration can be started from the <strong>Collaboration
                  menu</strong>, which can be opened from the right side of the
                  page. You can either create a new collaboration or join
                  an existing one. You can also decide whether or not
                  markers you have placed before the collaboration should
                  be added to the collaborative workspace or if they
                  should be removed. When collaborating, all participants
                  see the same points and can update them in real time.
              </p>
              <h5>Loading images</h5>
              <p>
                  Click the button labeled <strong>Image browser</strong>
                  to see a list of available images on the server. Click
                  one of the images to view it.
              </p>
              <h5>Navigating images</h5>
              <p>
                  The image viewer can be navigated with the mouse. The
                  mouse wheel is used to zoom in and out of the picture.
                  Holding down the left mouse button and dragging it inside
                  the image viewer pans the image. The focus can be changed
                  either by pressing the <strong>Up</strong> and <strong>Down</strong>
                  buttons on the right side of the page, pressing the
                  <kbd>z</kbd> and <kbd>x</kbd> buttons on the keyboard,
                  or holding down the <kbd>ctrl</kbd> key while scrolling
                  the mouse wheel.
              </p>
              <h5>Markers</h5>
              <p>
                  Click the image viewer to add a marker with the currently
                  selected class. The selected class can be set by either
                  clicking the class buttons on the right side of the page
                  or by pressing the number keys on the keyboard.
                  Markers can be moved by holding down the mouse button
                  on them and dragging them. To delete a marker, click
                  it while holding down the <kbd>ctrl</kbd> key. To quickly
                  move the image viewer to a specific marker, press the
                  corresponding button in the marker table.
              </p>
              <h5>Saving markers</h5>
              <p>
                  Markers can be saved to a file on the local machine by
                  pressing the <strong>Download</strong> button. Markers
                  that have been saved can be loaded into the image by
                  first selecting the file in the image browser and then
                  pressing the <strong>Import</strong> button.
          </div>
        </div>
      </div>
    </div> <!-- End of instructions -->

    <!-- Collaboration menu -->
    <div class="modal fade" id="collaboration_menu" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Collaboration</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div id="collaboration_start">
                  <div class="form-row pb-4">
                      <div class="col-12">
                          <input type="text" name="username" class="form-control" placeholder="Your name">
                      </div>
                  </div>
                  <div class="form-row pb-4">
                      <div class="col-8">
                          <input type="text" name="active_id" readonly class="form-control" placeholder="-">
                      </div>
                      <div class="col-4">
                          <button id="create_collaboration" class="btn btn-block btn-primary">Create</button>
                      </div>
                  </div>
                  <div class="form-row pb-4">
                      <div class="col-8">
                          <input type="text" name="joined_id" class="form-control" placeholder="Collaboration ID">
                      </div>
                      <div class="col-4">
                          <button id="join_collaboration" class="btn btn-block btn-primary">Join</button>
                      </div>
                  </div>
                  <div class="form-row pb-4">
                      <div class="col-12">
                          <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="include_points">
                              <label class="form-check-label" for="include_points">
                                  Add existing markers to collaboration
                              </label>
                          </div>
                      </div>
                  </div>
                  <h5>Collaboration members</h5>
                  <div class="card bg-secondary mb-4" style="height: 25vh; overflow-y: auto;">
                      <div id="collaborator_list" class="list-group list-group-flush">
                      </div>
                  </div>
                  <div class="form-row pb-4">
                      <div class="col-12">
                          <div class="input-group">
                              <input type="text" class="form-control" placeholder="Collaboration URL" readonly="" name="collab_url">
                              <div class="input-group-append">
                                  <button type="button" class="btn btn-primary">Copy URL</button>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="form-row pb-2">
                      <div class="col-12">
                          <button id="leave_collaboration" class="btn btn-block btn-secondary" disabled>Leave collaboration</button>
                      </div>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </div> <!-- End of image browser -->

</body>

<script src="js/bootstrap.4.0.0.bundle.min.js" ></script>
<script src="js/openseadragon.2.4.0.min.js"></script>
<script src="js/openseadragon-filtering.js"></script>
<script src="js/openseadragon-svg-overlay.js"></script>
<!-- <script src="js/tm_utils/interfaceUtils.js"></script> -->
<!-- <script src="js/tm_utils/dataUtils.js"></script> -->
<!-- <script src="js/tm_utils/CPDataUtils.js"></script> -->
<!-- <script src="js/tm_utils/markerUtils.js"></script> -->
<script src="js/tm_utils/OSDViewerUtils.js"></script>
<!-- <script src="js/tm_utils/HTMLElementUtils.js"></script> -->
<!-- <script src="js/tm_utils/regionUtils.js"></script> -->
<!-- <script src="js/tm_utils/overlayUtils.js"></script> -->
<!-- <script src="js/tm_utils/geometryUtils.js"></script> -->
<script src="js/utils/bethesdaClassUtils.js"></script>
<script src="js/utils/JSONUtils.js"></script>
<script src="js/utils/overlayUtils.js"></script>
<script src="js/utils/markerUtils.js"></script>
<script src="js/collabClient.js"></script>
<script src="js/markerPoints.js"></script>
<script src="js/overlayHandler.js"></script>
<script src="js/tmappUI.js"></script>
<script src="js/tmapp.js"></script>
<script>
    markerUtils._TMCPStyle={ strokeWidth: 4, radius: 80, drawText:false, textSize:1 };

    document.getElementById("project_title").innerText = "Cyto Browser";

    tmappUI.initUI();

    // Start our tmapp
    $(document).ready(function () {
        var url = new URL(window.location.href);
        tmapp.fixed_file = url.searchParams.get("image");
        tmapp.image_name = url.searchParams.get("image");
//        tmapp.registerActions();

        // Get the viewport params from the URL
        const initial_params = {
            zoom: url.searchParams.get("zoom"),
            x: url.searchParams.get("x"),
            y: url.searchParams.get("y"),
            z: url.searchParams.get("z")
        };
        // Check if all params are present
        const values = Object.values(initial_params);
        const params_defined = values.every(value => value != null);

        // Set the initial params if all are defined
        if (params_defined) {
            // Convert to numbers first
    	    for (const [key, value] of Object.entries(initial_params)) {
                    initial_params[key] = Number(value);
    	    }
            tmapp.initial_params = initial_params;
        }

        // If the URL contains a collab, instantly join it
        const collab = url.searchParams.get("collab");
        if (collab) {
            tmapp.init(() => {
                const name = collabClient.getDefaultName();
                collabClient.connect(collab, name);
            });
        }
        else {
            tmapp.init();
        }
    });

    // UI setters
    function setImageName(txt) {
        document.getElementById("img_name").innerText=txt;
    }
    function setImageZLevel(txt) {
        document.getElementById("img_zlevel").innerText=txt;
    }
    function setImageZoom(txt) {
        document.getElementById("img_zoom").innerText=txt;
    }
    function setURL(txt) {
        window.history.pushState(null, "", txt);
    }

    $(document).mousedown(function(event){
        if (!(document.hasFocus())) {
            console.log("Lost focus, ignoreing click and setting focus")
            tmapp.fixed_viewer.canvas.focus();
        }
    });
</script>
</html>
